name: E2E Tests

on:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          registry-url: "https://npm.pkg.github.com"
          scope: "@icco"

      - name: Install dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Playwright browsers
        run: yarn playwright install chromium --with-deps

      - name: Run E2E tests
        id: e2e
        run: yarn test:e2e --update-snapshots
        continue-on-error: true
        env:
          CI: true
          E2E_MOCK: "true"
          GRPC_API_KEY: "test-api-key"
          NEXTAUTH_SECRET: "test-secret-for-e2e"

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-screenshots
          path: |
            e2e/**/*.png
            test-results/
            playwright-report/
          retention-days: 30

      - name: Commit screenshots to PR branch
        if: always()
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any screenshot changes
          git add e2e/**/*.png || true
          
          if git diff --cached --quiet; then
            echo "No screenshot changes to commit"
          else
            git commit -m "chore: update e2e screenshots [skip ci]"
            git push origin HEAD:${{ github.head_ref }}
          fi

      - name: Comment PR with screenshots
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          TEST_OUTCOME: ${{ steps.e2e.outcome }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const testOutcome = process.env.TEST_OUTCOME;
            const passed = testOutcome === 'success';
            const statusEmoji = passed ? 'âœ…' : 'âŒ';
            const statusText = passed ? 'passed' : 'failed';

            // Find all screenshot files
            const findScreenshots = (dir, files = []) => {
              if (!fs.existsSync(dir)) return files;
              const items = fs.readdirSync(dir);
              for (const item of items) {
                const fullPath = path.join(dir, item);
                if (fs.statSync(fullPath).isDirectory()) {
                  findScreenshots(fullPath, files);
                } else if (item.endsWith('.png')) {
                  files.push(fullPath);
                }
              }
              return files;
            };

            const screenshots = findScreenshots('e2e');

            if (screenshots.length === 0) {
              console.log('No screenshots found');
              return;
            }

            // Get artifact URL
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const screenshotArtifact = artifacts.artifacts.find(a => a.name === 'e2e-screenshots');
            const artifactUrl = screenshotArtifact
              ? `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${screenshotArtifact.id}`
              : `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Build image URLs from the PR branch
            const prBranch = context.payload.pull_request.head.ref;
            const rawBaseUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/${prBranch}`;

            // Group screenshots by test file
            const groupedScreenshots = {};
            for (const screenshot of screenshots) {
              const parts = screenshot.split('/');
              // Path like: e2e/landing.spec.ts-snapshots/landing-hero-1-chromium-linux.png
              const testFile = parts[1]?.replace('.spec.ts-snapshots', '') || 'other';
              if (!groupedScreenshots[testFile]) {
                groupedScreenshots[testFile] = [];
              }
              groupedScreenshots[testFile].push(screenshot);
            }

            // Build screenshot gallery
            let screenshotGallery = '';
            for (const [testFile, files] of Object.entries(groupedScreenshots)) {
              screenshotGallery += `\n<details>\n<summary><strong>${testFile}</strong> (${files.length} screenshots)</summary>\n\n`;
              for (const file of files) {
                const fileName = path.basename(file);
                const imageUrl = `${rawBaseUrl}/${file}`;
                screenshotGallery += `#### ${fileName}\n![${fileName}](${imageUrl})\n\n`;
              }
              screenshotGallery += `</details>\n`;
            }

            const body = [
              `## ${statusEmoji} E2E Screenshot Tests ${statusText}`,
              '',
              `**${screenshots.length} screenshots** were captured during the E2E test run.`,
              '',
              screenshotGallery,
              '',
              '---',
              `ðŸ“¦ [Download all screenshots](${artifactUrl})`,
              '',
              `<sub>Generated by E2E workflow run [#${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) â€¢ Last updated: ${new Date().toISOString()}</sub>`,
            ].join('\n');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('E2E Screenshot Tests')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body,
              });
              console.log(`Updated existing comment ${existingComment.id}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
              console.log('Created new comment');
            }

      - name: Fail if tests failed
        if: steps.e2e.outcome == 'failure'
        run: exit 1
